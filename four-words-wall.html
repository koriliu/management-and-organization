<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Whiteboard - MM2021</title>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root">
        <div id="app-loading" style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1e293b,#334155);color:#e2e8f0;font-family:system-ui,sans-serif;font-size:1.1rem;">
            Loading whiteboardâ€¦
        </div>
    </div>

    <script>
        window.addEventListener('error', function(e) {
            var root = document.getElementById('root');
            if (root && !document.getElementById('app-error')) {
                root.innerHTML = '<div id="app-error" style="min-height:100vh;padding:24px;background:#fef2f2;color:#991b1b;font-family:system-ui,sans-serif;"><h2 style="margin-top:0;">Error</h2><pre style="background:#fff;padding:12px;overflow:auto;border-radius:8px;font-size:12px;">' + (e.message || '') + '</pre><p style="font-size:14px;">File: ' + (e.filename || '') + ' (line ' + (e.lineno || '') + ')</p><p>Check the Console (F12) for more.</p></div>';
            }
        });
        window.addEventListener('unhandledrejection', function(e) {
            var root = document.getElementById('root');
            if (root && !document.getElementById('app-error')) {
                root.innerHTML = '<div id="app-error" style="min-height:100vh;padding:24px;background:#fef2f2;color:#991b1b;font-family:system-ui,sans-serif;"><h2 style="margin-top:0;">Load error</h2><pre style="background:#fff;padding:12px;overflow:auto;border-radius:8px;font-size:12px;">' + (e.reason && (e.reason.message || e.reason)) + '</pre><p>Check the Console (F12) for more.</p></div>';
            }
        });
    </script>

    <!-- Load at end of body: no ES modules so Babel only compiles JSX (avoids .targets["esmodules"] error) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- Icons ---
        const Camera = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
        );
        const Plus = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        );
        const X = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        );
        const Maximize2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
        );
        const Users = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        );
        const Loader2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        );
        const ImageIcon = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        );

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrDW8aSrcPSLWOIZGWp21qw61-nLquTMo",
            authDomain: "whiteboard2-1c071.firebaseapp.com",
            projectId: "whiteboard2-1c071",
            storageBucket: "whiteboard2-1c071.firebasestorage.app",
            messagingSenderId: "126531560326",
            appId: "1:126531560326:web:a4f693da542ef442ac4207"
        };

        let app = null;
        let auth = null;
        let db = null;
        let storage = null;
        let firebaseError = null;

        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
            } else {
                firebaseError = "Firebase not configured. Edit whiteboard.html and add your Firebase config.";
            }
        } catch (e) {
            firebaseError = e.message || "Firebase failed to initialize.";
        }

        // Collection name (simplified)
        const COLLECTION_NAME = 'whiteboard_submissions';

        // --- Image Compression Helper ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200;
                        const MAX_HEIGHT = 1200;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Failed to compress image'));
                            }
                        }, 'image/jpeg', 0.85);
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        // --- Components ---

        const Lightbox = ({ submission, onClose }) => {
            if (!submission) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/95 backdrop-blur-sm p-4 animate-[fadeIn_0.2s_ease-out]">
                    <button 
                        onClick={onClose}
                        className="absolute top-4 right-4 p-2 bg-white/10 hover:bg-white/20 text-white rounded-full transition-colors"
                    >
                        <X size={32} />
                    </button>
                    
                    <div className="max-w-7xl w-full max-h-screen flex flex-col items-center">
                        <img 
                            src={submission.imageUrl} 
                            alt={`Group ${submission.groupNumber}`} 
                            className="max-h-[85vh] object-contain rounded-lg shadow-2xl border border-white/10"
                        />
                        <div className="mt-4 text-white text-xl font-medium flex items-center gap-2">
                            <span className="bg-blue-600 px-3 py-1 rounded-full text-sm font-bold uppercase tracking-wider">
                                Group {submission.groupNumber}
                            </span>
                            {submission.createdAt && (
                                <span className="text-gray-400 text-sm">
                                    {new Date(submission.createdAt.seconds * 1000).toLocaleString()}
                                </span>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const UploadModal = ({ isOpen, onClose, onUpload, isUploading }) => {
            const [file, setFile] = useState(null);
            const [groupNumber, setGroupNumber] = useState('');
            const [preview, setPreview] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (!isOpen) {
                    setFile(null);
                    setGroupNumber('');
                    setPreview(null);
                }
            }, [isOpen]);

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    setFile(selectedFile);
                    const objectUrl = URL.createObjectURL(selectedFile);
                    setPreview(objectUrl);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!file || !groupNumber) {
                    alert("Please select a file and enter a group number.");
                    return;
                }
                await onUpload(file, groupNumber);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-[zoomIn_0.2s_ease-out]">
                        <div className="bg-slate-50 border-b border-slate-100 p-4 flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-slate-800">Submit Work</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600">
                                <X size={24} />
                            </button>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="p-6 space-y-6">
                            <div 
                                onClick={() => fileInputRef.current?.click()}
                                className={`
                                    relative group cursor-pointer rounded-xl border-2 border-dashed 
                                    ${preview ? 'border-blue-300 bg-slate-50' : 'border-slate-300 hover:border-blue-400 hover:bg-slate-50'}
                                    h-48 flex flex-col items-center justify-center transition-all duration-200
                                `}
                            >
                                {preview ? (
                                    <img src={preview} alt="Preview" className="h-full w-full object-contain p-2" />
                                ) : (
                                    <div className="text-center p-4">
                                        <div className="bg-blue-50 text-blue-500 rounded-full p-3 w-fit mx-auto mb-3 group-hover:scale-110 transition-transform">
                                            <Camera size={24} />
                                        </div>
                                        <p className="text-slate-600 font-medium">Click to upload photo</p>
                                        <p className="text-slate-400 text-xs mt-1">Supports JPG, PNG</p>
                                    </div>
                                )}
                                <input 
                                    ref={fileInputRef}
                                    type="file" 
                                    accept="image/*" 
                                    onChange={handleFileChange} 
                                    className="hidden" 
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Group Number</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                        <Users size={18} />
                                    </div>
                                    <input
                                        type="number"
                                        value={groupNumber}
                                        onChange={(e) => setGroupNumber(e.target.value)}
                                        placeholder="e.g. 5"
                                        className="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                        required
                                    />
                                </div>
                            </div>

                            <button
                                type="submit"
                                disabled={isUploading}
                                className={`
                                    w-full py-3 px-4 rounded-xl text-white font-medium shadow-lg shadow-blue-500/20
                                    flex items-center justify-center gap-2
                                    ${isUploading 
                                        ? 'bg-slate-300 cursor-not-allowed shadow-none' 
                                        : 'bg-blue-600 hover:bg-blue-700 active:scale-95 transition-all'}
                                `}
                            >
                                {isUploading ? (
                                    <>
                                        <Loader2 className="animate-spin" size={20} />
                                        Uploading...
                                    </>
                                ) : (
                                    "Post to Whiteboard"
                                )}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---

        function ClassroomWhiteboard() {
            const [user, setUser] = useState(null);
            const [submissions, setSubmissions] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isUploading, setIsUploading] = useState(false);
            const [activeSubmission, setActiveSubmission] = useState(null);
            const [loading, setLoading] = useState(true);

            if (firebaseError || !db) {
                return (
                    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-6">
                        <div className="max-w-md w-full bg-white rounded-2xl shadow-xl border border-slate-200 p-8 text-center">
                            <h1 className="text-xl font-bold text-slate-800 mb-2">Classroom Whiteboard</h1>
                            <p className="text-slate-600 mb-4">Firebase is not set up. The page will stay blank until you add your config.</p>
                            <p className="text-sm text-amber-700 bg-amber-50 rounded-lg p-3 mb-4 font-mono text-left break-all">
                                {firebaseError || "Add your Firebase config in whiteboard.html (search for firebaseConfig)."}
                            </p>
                            <p className="text-xs text-slate-500">
                                Use the same Firebase project as four-words-wall, or create one. Enable Anonymous Auth, Firestore, and Storage.
                            </p>
                        </div>
                    </div>
                );
            }
            const [error, setError] = useState(null);

            // Initialize Auth
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Auth failed:", e);
                        setError("Authentication failed. Please check Firebase configuration.");
                        setLoading(false);
                    }
                };
                initAuth();
                
                return onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) setLoading(false);
                });
            }, []);

            // Subscribe to Firestore Data
            useEffect(() => {
                if (!user) return;

                const collectionRef = collection(db, COLLECTION_NAME);
                const q = query(collectionRef, orderBy('createdAt', 'desc'));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const docs = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setSubmissions(docs);
                }, (error) => {
                    console.error("Firestore error:", error);
                    setError("Failed to load submissions. Check Firestore rules.");
                });

                return () => unsubscribe();
            }, [user]);

            // Handle Upload
            const handleUpload = async (file, groupNumber) => {
                if (!user) {
                    alert("Not authenticated. Please refresh the page.");
                    return;
                }
                
                setIsUploading(true);
                setError(null);

                try {
                    // Compress image
                    const compressedBlob = await compressImage(file);
                    
                    // Upload to Firebase Storage
                    const timestamp = Date.now();
                    const fileName = `group_${groupNumber}_${timestamp}.jpg`;
                    const storageRef = ref(storage, `whiteboard/${fileName}`);
                    
                    await uploadBytes(storageRef, compressedBlob);
                    const downloadURL = await getDownloadURL(storageRef);
                    
                    // Save metadata to Firestore
                    const collectionRef = collection(db, COLLECTION_NAME);
                    await addDoc(collectionRef, {
                        imageUrl: downloadURL,
                        groupNumber: groupNumber,
                        createdAt: serverTimestamp(),
                        userId: user.uid,
                        fileName: fileName
                    });
                    
                    alert("Success! Your work has been uploaded.");
                    setIsModalOpen(false);
                } catch (error) {
                    console.error("Upload failed:", error);
                    setError("Upload failed: " + error.message);
                    alert("Upload failed: " + error.message);
                } finally {
                    setIsUploading(false);
                }
            };

            return (
                <div 
                    className="min-h-screen font-sans selection:bg-yellow-200"
                    style={{
                        backgroundColor: '#87CEEB',
                        backgroundImage: `
                            radial-gradient(circle at 10% 20%, rgb(220, 245, 255) 0%, transparent 20%),
                            radial-gradient(circle at 80% 80%, rgb(220, 245, 255) 0%, transparent 25%),
                            linear-gradient(135deg, #87CEEB 0%, #4facfe 100%)
                        `,
                        backgroundAttachment: 'fixed',
                        backgroundSize: 'cover'
                    }}
                >
                    <header className="sticky top-0 z-30 bg-white/90 backdrop-blur-md border-b border-white/40 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 text-white p-2 rounded-lg shadow-blue-300 shadow-lg">
                                    <ImageIcon size={24} />
                                </div>
                                <div>
                                    <h1 className="font-bold text-xl leading-none text-slate-800">ClassBoard</h1>
                                    <p className="text-xs text-slate-500 font-bold mt-1 uppercase tracking-wide">MM2021 Management and Organization</p>
                                </div>
                            </div>
                            
                            <button 
                                onClick={() => setIsModalOpen(true)}
                                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-lg shadow-blue-500/30 active:scale-95 transition-all flex items-center gap-2 border border-blue-400"
                            >
                                <Plus size={20} />
                                <span className="hidden sm:inline">Submit Work</span>
                                <span className="sm:hidden">Add</span>
                            </button>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {error && (
                            <div className="mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                                {error}
                            </div>
                        )}
                        
                        {loading ? (
                            <div className="flex flex-col items-center justify-center h-64 text-white drop-shadow-md">
                                <Loader2 className="animate-spin mb-4" size={32} />
                                <p className="font-medium text-lg">Loading whiteboard...</p>
                            </div>
                        ) : submissions.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-[60vh] text-slate-600 border-4 border-dashed border-white/50 rounded-3xl bg-white/30 backdrop-blur-sm">
                                <div className="bg-white/80 p-6 rounded-full mb-4 shadow-xl">
                                    <Camera size={48} className="text-blue-400" />
                                </div>
                                <h3 className="text-2xl font-bold text-slate-800 drop-shadow-sm">The board is empty</h3>
                                <p className="max-w-xs text-center mt-2 text-slate-700 font-medium">Be the first group to submit your work!</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                                {submissions.map((item) => (
                                    <div 
                                        key={item.id}
                                        onClick={() => setActiveSubmission(item)}
                                        className="group relative aspect-[3/4] bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 cursor-zoom-in overflow-hidden border-4 border-white hover:-translate-y-1 hover:rotate-1"
                                    >
                                        <img 
                                            src={item.imageUrl} 
                                            alt={`Group ${item.groupNumber}`} 
                                            className="w-full h-full object-cover"
                                            loading="lazy"
                                        />
                                        <div className="absolute inset-0 bg-gradient-to-t from-blue-900/90 via-transparent to-transparent opacity-60 group-hover:opacity-80 transition-opacity" />
                                        <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                            <div className="bg-white/20 backdrop-blur-md p-3 rounded-full text-white border border-white/50">
                                                <Maximize2 size={24} />
                                            </div>
                                        </div>
                                        <div className="absolute bottom-0 left-0 right-0 p-3 text-white">
                                            <div className="flex items-center justify-between">
                                                <span className="font-bold text-lg tracking-tight drop-shadow-md">Group {item.groupNumber}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    <UploadModal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)} 
                        onUpload={handleUpload}
                        isUploading={isUploading}
                    />
                    
                    {activeSubmission && (
                        <Lightbox 
                            submission={activeSubmission} 
                            onClose={() => setActiveSubmission(null)} 
                        />
                    )}
                </div>
            );
        }

        const rootEl = document.getElementById('root');
        try {
            const root = createRoot(rootEl);
            root.render(<ClassroomWhiteboard />);
        } catch (e) {
            rootEl.innerHTML = '<div style="min-height:100vh;padding:24px;background:#fef2f2;color:#991b1b;font-family:system-ui,sans-serif;"><h2 style="margin-top:0;">Error loading app</h2><pre style="background:#fff;padding:12px;overflow:auto;border-radius:8px;">' + (e.message || String(e)) + '</pre><p>Open the browser console (F12) for more details.</p></div>';
        }
        setTimeout(function() {
            const loading = document.getElementById('app-loading');
            if (loading && loading.parentElement === rootEl) {
                rootEl.innerHTML = '<div style="min-height:100vh;padding:24px;background:#fef3c7;color:#92400e;font-family:system-ui,sans-serif;"><h2 style="margin-top:0;">Still loading?</h2><p>If the whiteboard did not appear, press <strong>F12</strong> to open Developer Tools and check the <strong>Console</strong> tab for errors.</p></div>';
            }
        }, 8000);
    </script>
</body>
</html>




